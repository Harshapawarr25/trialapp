<!DOCTYPE html>
<html>

<head>
    <title>Advanced AngularJS App</title>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>

    <style>
        body {
            font-family: Segoe UI;
            background: #eef2f5;
            margin: 0;
        }

        nav {
            background: #2c3e50;
            padding: 15px;
            text-align: center;
        }

        nav a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-weight: bold;
        }

        .container {
            padding: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }

        input, select {
            padding: 8px;
            width: 100%;
            margin: 8px 0;
            box-sizing: border-box;
        }

        button {
            padding: 8px 15px;
            background: #3498db;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }

        th {
            background: #34495e;
            color: white;
        }
    </style>
</head>

<body ng-app="advancedApp">

<nav>
    <a href="#!/dashboard">Dashboard</a>
    <a href="#!/manage">Manage Products</a>
</nav>

<div class="container">
    <div ng-view></div>
</div>

<script>
    var app = angular.module("advancedApp", ["ngRoute"]);

    /* ROUTING */
    app.config(function ($routeProvider) {
        $routeProvider
            .when("/dashboard", {
                template: `
                <div class="card">
                    <h2>ðŸ“Š Dashboard</h2>
                    <p>Total Products: {{total}}</p>
                    <p>Last Action: {{lastAction}}</p>
                </div>
                `,
                controller: "dashboardCtrl"
            })
            .when("/manage", {
                template: `
                <div class="card">
                    <h2>ðŸ›  Product Management</h2>

                    <input type="text" ng-model="product.name" placeholder="Product Name">
                    <input type="number" ng-model="product.price" placeholder="Price">
                    <select ng-model="product.category">
                        <option value="">-- Select Category --</option>
                        <option>Electronics</option>
                        <option>Fashion</option>
                        <option>Accessories</option>
                    </select>

                    <button ng-click="addProduct()">Add Product</button>

                    <hr>

                    <input type="text" ng-model="search" placeholder="Search...">

                    <table>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Action</th>
                        </tr>
                        <!-- FIX: iterate over filteredProducts to get correct index for deletion -->
                        <tr ng-repeat="p in filteredProducts = (products | filter:search)">
                            <td highlight>{{p.name}}</td>
                            <td>{{p.price | currency:'â‚¹'}}</td>
                            <td>{{p.category}}</td>
                            <td>
                                <!-- FIX: pass the product object itself, not $index -->
                                <button ng-click="deleteProduct(p)">Delete</button>
                            </td>
                        </tr>
                        <tr ng-if="filteredProducts.length === 0">
                            <td colspan="4" style="color:#999;">No products found.</td>
                        </tr>
                    </table>
                </div>
                `,
                controller: "manageCtrl"
            })
            .otherwise({ redirectTo: "/dashboard" });
    });

    /* SERVICE (SHARED DATA) */
    app.service("productService", function () {
        var products = [];
        var lastAction = "Application Loaded";

        this.getProducts = function () {
            return products;
        };

        this.add = function (p) {
            products.push(p);
            lastAction = "Product added: " + p.name;
        };

        // FIX: remove by object reference instead of index
        this.remove = function (product) {
            var index = products.indexOf(product);
            if (index !== -1) {
                lastAction = "Product deleted: " + product.name;
                products.splice(index, 1);
            }
        };

        this.getLastAction = function () {
            return lastAction;
        };
    });

    /* CUSTOM DIRECTIVE */
    app.directive("highlight", function () {
        return {
            restrict: "A",
            link: function (scope, element) {
                element.on("mouseenter", function () {
                    element.css("background", "#f1c40f");
                });
                element.on("mouseleave", function () {
                    element.css("background", "");
                });
            }
        };
    });

    /* DASHBOARD CONTROLLER */
    // FIX: use $interval to poll service state so dashboard stays reactive
    app.controller("dashboardCtrl", function ($scope, $interval, productService) {
        $scope.total = productService.getProducts().length;
        $scope.lastAction = productService.getLastAction();

        var poller = $interval(function () {
            $scope.total = productService.getProducts().length;
            $scope.lastAction = productService.getLastAction();
        }, 500);

        // Clean up interval when leaving the dashboard
        $scope.$on("$destroy", function () {
            $interval.cancel(poller);
        });
    });

    /* MANAGEMENT CONTROLLER */
    app.controller("manageCtrl", function ($scope, productService) {
        $scope.products = productService.getProducts();

        // FIX: initialize product so ng-model bindings work from the start
        $scope.product = { name: "", price: null, category: "" };

        $scope.addProduct = function () {
            if (!$scope.product.name || !$scope.product.price || !$scope.product.category) {
                alert("Please fill in all fields before adding a product.");
                return;
            }
            productService.add(angular.copy($scope.product));
            $scope.product = { name: "", price: null, category: "" };
        };

        // FIX: accept product object and remove by reference
        $scope.deleteProduct = function (product) {
            productService.remove(product);
        };
    });
</script>

</body>
</html>